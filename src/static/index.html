<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    .canvas {
      border: 2px solid;
      width: max-content;
    }
    .row {
      display: flex;
    }
    .dot {
      width: 10px;
      height: 10px;
      border: 2px solid;
    }
    

    .common-colors {
      margin-top: 10px;
      background-color: #f3f3f3;
      padding: 3px;
    }

    .color-card {
      display: inline-block;
      width: 21px;
      height: 21px;
      background-color: currentColor;
      border: 1px solid #000;
      border-radius: 3px;
      margin: 5px;
      vertical-align: bottom;
    }

    .color-card.active {
      width: 25px;
      height: 25px;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="canvas">
      <canvas @click='handleCanvasClick' ref='canvas' :width='width' :height='height'></canvas>
    </div>
    <button @click='startPickingColor'>{{pickingColor ? '正在取色' : '取色'}}</button>
    <input type="color" v-model='color' value='red'>
    <div class='common-colors'>
      <span v-for='c of commonColors' @click='color=c' :class='{"color-card":true,active:c==color}' :style='{color:c}'></span>
    </div>
  </div>
</body>
<script src="vue-2.5.17.js"></script>
<script>
  const app = new Vue({
    el: '#app',
    data() {
      return {
        pixelData: [],
        commonColors: ['#000000','#ffffff','#aaaaaa','#555555','#fed3c7','#ffc4ce','#faac8e','#ff8b83','#f44336','#e91e63','#e2669e','#9c27b0','#673ab7','#3f51b5','#004670','#0571197','#2196f3','#00bcd4','#3be5db','#97fddc','#167300','#37a93c','#89e642','#d7ff07','#fff6d1','#f8cb8c','#ffeb3b','#ffc107','#ff9800','#ff5722','#b83f27','#795548'],
        color: 'red',
        width: 256,
        height: 256,
        pickingColor: false,
      }
    },
    methods: {
      makeCursorImg (color) {
        let cursor = document.createElement('canvas')
        let ctx = cursor.getContext('2d')
        cursor.width = 41
        cursor.height = 41

        ctx.beginPath()
        ctx.lineWidth = 2
        ctx.strokeStyle = '#000000'
        ctx.moveTo(0, 6)
        ctx.lineTo(12, 6)
        ctx.moveTo(6, 0)
        ctx.lineTo(6, 12)
        ctx.stroke()

        ctx.beginPath()
        ctx.arc(25, 25, 14, 0, 2 * Math.PI, false)
        ctx.lineWidth = 2
        ctx.strokeStyle = '#000000'
        ctx.stroke()
        ctx.beginPath()
        ctx.arc(25, 25, 13.4, 0, 2 * Math.PI, false)
        ctx.fillStyle = color
        ctx.fill()

        // document.getElementById('canvas').style.cursor = 'crosshair'
        // document.getElementById('canvas').style.cursor = 'url(' + cursor.toDataURL() + ') 6 6, crosshair'

        return cursor.toDataURL()
      },

      handleCanvasClick(e) {
        
        if (this.pickingColor) {
          this.pickColor(e)
        } else {
          this.drawDot(e)
        }
      },
      rgba2hex(dot) {
        dot = Array.from(dot)
        var dot = dot.map(it => it.toString(16).padStart(2, '0'))
        return '#'+dot[0]+dot[1]+dot[2]
      },
      updateCursor: function (e) {
        let color = this.getCurrHoverColor(e)
        let cursorUrl = this.makeCursorImg(color)
        // refs Vue自带的准确元素集
        console.log(e)
        this.$refs.canvas.style.cursor = `url(${cursorUrl}) 6 6, crosshair`
        console.log(this.$refs.canvas.style.cursor)
      },
      getCurrHoverColor(e) {
        let box = this.$refs.canvas.getBoundingClientRect()
        let x = Math.floor((e.clientX - box.left) * this.$refs.canvas.width / box.width)
        let y = Math.floor((e.clientY - box.top) * this.$refs.canvas.height / box.height)
        let p = this.ctx.getImageData(x, y, 1, 1).data
        let hexColor = this.rgba2hex(p)
        return hexColor
      },
      startPickingColor() {
        this.isPickingColor = true
        this.$refs.canvas.addEventListener('mousemove', this.updateCursor)
      },
      pickColor(e) {
        let hexColor = this.getCurrHoverColor(e)
        this.pickingColor = false
        this.color = hexColor
        this.$refs.canvas.removeEventListener('mousemove', this.updateCursor)
        this.$refs.canvas.style.cursor = ''
      }, 
      drawDot(e) {
        let box = this.$refs.canvas.getBoundingClientRect()
        let x = Math.floor((e.clientX - box.left) * this.$refs.canvas.width / box.width)
        let y = Math.floor((e.clientY - box.top) * this.$refs.canvas.height / box.height)
        this.ws.send(JSON.stringify({
          type: 'drawDot',
          x: x,
          y: y,
          color: this.color,
        }))
      }
    },
    mounted() {
      var ws = new WebSocket('ws://localhost:9095/pixel')
      this.ws = ws

      let canvas = this.$refs.canvas
      canvas.style.imageRendering = 'pixelated'

      let ctx = canvas.getContext('2d')
      this.ctx = ctx
      //ctx.webkitImageSmoothingEnabled = false;
      //ctx.mozImageSmoothingEnabled = false;
      //ctx.imageSmoothingEnabled = false;

      ws.onmessage = (e) => {



        var data = e.data
        
        if (Object.prototype.toString.call(data) === '[object Blob]') {
          console.log('blob');
          let tmpUrl = URL.createObjectURL(data)
          console.log(tmpUrl)
          let image = new Image()
          image.src = tmpUrl
          
          document.body.appendChild(image)
          image.onload=() => {
            ctx.drawImage(image,0,0)
          }
        } else {
          data = JSON.parse(data)
          if (data.type === 'init') {
            //this.pixelData = data.pixelData
            this.width = data.pixelData[0].length
            this.height = data.pixelData.length

            Vue.nextTick(() => {
              data.pixelData.forEach((row, y) => {
                row.forEach((color,x) => {
                  ctx.fillStyle = color
                  ctx.fillRect(x,y,1,1)
                })
              })
            })
            
          } else if (data.type === 'updateDot') {
            ctx.fillStyle = data.color
            ctx.fillRect(data.x, data.y, 1, 1)
          }
        }
        
      }

    }
  })
</script>
</html>